<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Transaction Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f4f6f8;
      padding-top: 60px;
    }

    .navbar {
      position: fixed;
      padding: 0;
      /* Remove default navbar padding */
      height: 60px;
      /* Set navbar height */
      top: 0;
      left: 0;
      width: 100%;
      z-index: 2000;
    }

    .navbar-center {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
      /* lets clicks go to buttons */
      height: 100%;
      max-width: 60%;
      /* prevents overlapping */
    }

    .navbar-logo {
      height: 80%;
      width: auto;
      max-width: 100%;
    }

    /* Adjust for very small screens */
    @media (max-width: 480px) {
      .navbar-center {
        max-width: 50%;
      }

      .navbar-logo {
        height: 90%;
        /* slightly smaller to fit */
      }
    }


    .login-logo {
      max-width: 200px;
      /* adjust as needed */
      height: auto;
    }

    #login {
      position: fixed;
      /* stay in viewport */
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      /* full viewport height */
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f4f6f8;
      z-index: 3000;
      /* above navbar and drawer */
      overflow: hidden;
      /* prevent scrollbars */
    }


    .drawer {
      position: fixed;
      top: 0;
      left: -320px;
      width: 300px;
      height: 100%;
      background: url('https://raw.githubusercontent.com/TheSauravBiswas/td/main/IMG_20260117_102749.png') no-repeat center center;
      background-size: cover;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.15);
      padding: 15px;
      transition: 0.3s;
      z-index: 2100;
      overflow-y: auto;
      color: #ffffff;
    }

    .drawer-logo {
      max-width: 120px;
      /* Adjust to your preference */
      height: auto;
      display: block;
      margin: 0 auto;
      /* Center horizontally */
      border-radius: 8px;
      /* Optional: soft rounded corners */
    }

    .drawer-close-btn {
      position: absolute;
      top: 10px;
      /* distance from top */
      right: 10px;
      /* distance from right */
      z-index: 1100;
      /* above drawer content */
    }


    .drawer>* {
      position: relative;
      z-index: 1;
    }

    .drawer.open {
      left: 0;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      z-index: 2050;
    }

    .overlay.show {
      display: block;
    }

    /* Mobile adjustments for navbar and drawer */
    @media (max-width: 768px) {
      #sheetSelect {
        display: none;
        /* hide navbar dropdown on mobile */
      }

      #drawerSheetSelect {
        display: block;
        margin-bottom: 1rem;
        background-color: transparent;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.5);
      }

      #drawerSheetSelect option {
        color: #fff;
        /* white text */
        background-color: #2c2c2c;
        /* dark background */
      }


      .navbar button[onclick="refreshDashboard()"] {
        padding: 0.25rem 0.5rem;
        font-size: 1.1rem;
        width: 38px;
        height: 38px;
      }
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="login" class="d-flex vh-100 justify-content-center align-items-center">
    <div class="card p-4 shadow" style="width:300px">
      <div class="text-center mb-3">
        <img src="Nagad-Vertical-Logo.wine.png" alt="App Logo" class="login-logo">
      </div>

      <input type="password" id="password" class="form-control mb-2" placeholder="Enter password">
      <button class="btn btn-primary w-100" onclick="handleLogin()">Login</button>
      <div id="loginError" class="text-danger mt-2 text-center"></div>
    </div>
  </div>

  <!-- DRAWER -->
  <div id="overlay" class="overlay" onclick="closeDrawer()"></div>
  <div id="drawer" class="drawer">

    <button class="btn btn-sm btn-outline-secondary drawer-close-btn" onclick="closeDrawer()">âœ•</button>

    <div class="text-center mb-3">
      <img src="https://raw.githubusercontent.com/TheSauravBiswas/td/main/nagad_white_logo.png" alt="App Logo" class="drawer-logo">
    </div>

    <div id="drawerDropdown" class="mb-3 d-none">
      <select id="drawerSheetSelect" class="form-select" onchange="loadSelectedSheetFromDrawer()">
        <!-- Options populated dynamically -->
      </select>
    </div>


    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5>Manage Sheets</h5>
    </div>

    <div id="addSection">
      <input id="sheetName" class="form-control mb-2" placeholder="Sheet Display Name">
      <input id="sheetUrl" class="form-control mb-2" placeholder="Google Sheet Share Link">
      <button class="btn btn-success w-100 mb-3" onclick="addSheet(this)">Add Sheet</button>
    </div>

    <!-- Edit Sheet Section (hidden by default) -->
    <div id="editSection" class="d-none">
      <input id="editSheetName" class="form-control mb-2" placeholder="Edit Sheet Name">
      <input id="editSheetUrl" class="form-control mb-2" placeholder="Edit Google Sheet Link">
      <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-primary" onclick="submitEdit(this)">Submit Edit</button>
        <button class="btn btn-secondary" onclick="discardEdit()">Discard</button>
      </div>
    </div>

    <div id="sheetList"></div>
  </div>

  <!-- APP -->
  <div id="app" class="d-none">
    <nav class="navbar navbar-dark bg-dark px-3">
      <button class="btn btn-outline-light me-2" onclick="openDrawer()">â˜°</button>

      <select id="sheetSelect" class="form-select w-auto" onchange="loadSelectedSheet()"></select>

      <div class="navbar-center">
        <img src="Nagad-Logo.wine.png" alt="App Logo" class="navbar-logo">
      </div>

      <div class="ms-auto d-flex align-items-center">
        <button class="btn btn-outline-light ms-2" onclick="refreshDashboard(this)">
          <span class="d-none d-md-inline">ðŸ”„ Refresh</span>
          <span class="d-inline d-md-none">ðŸ”„</span>
        </button>

      </div>
    </nav>

    <div class="container mt-4">
      <input id="search" class="form-control mb-3" placeholder="Search by anything..." oninput="renderTable()">

      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead class="table-dark">
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>From</th>
              <th>Amount</th>
              <th>TrxID</th>
              <th>Balance</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ================= CONFIG =================
    const PASSWORD_HASH = "dc7897da62b97f518863cd7587dc5e9d9b0ce78441e2d6ba57e3d5582b90e370";
    const MASTER_API = "https://script.google.com/macros/s/AKfycbxj2pfk-Tx2_BRSDQE4YRQi0sfBp5O3OJwIf-wERye_8zaJqTBz0UNXKA5sP0bJxpxg/exec";

    let transactions = [];
    let sheets = [];
    let editingIndex = null;

    // ================= SPINNER =================
    function createSpinner() {
      return '<span class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>';
    }

    function showOverlaySpinner(show = true) {
      let overlaySpinner = document.getElementById("overlaySpinner");
      if (!overlaySpinner) {
        overlaySpinner = document.createElement("div");
        overlaySpinner.id = "overlaySpinner";
        overlaySpinner.style = `
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
    `;
        overlaySpinner.innerHTML = '<div class="spinner-border text-light" role="status"></div>';
        document.body.appendChild(overlaySpinner);
      }
      overlaySpinner.style.display = show ? "flex" : "none";
    }

    // ================= LOGIN =================
    async function handleLogin(btn) {
      btn = btn || event.target;
      const passwordInput = document.getElementById("password");
      const loginBox = document.getElementById("login");
      const app = document.getElementById("app");
      const loginError = document.getElementById("loginError");

      // Show spinner on button
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Logging in...' + createSpinner();

      try {
        const input = passwordInput.value.trim();
        const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(input));
        const hash = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");

        if (hash === PASSWORD_HASH) {
          loginBox.classList.add("d-none");
          app.classList.remove("d-none");
          loginError.innerText = "";
          await loadMasterSheets();
          if (sheets.length > 0) {
            sheetSelect.value = 0;
            drawerSheetSelect.value = 0;
            await loadSelectedSheet();
          }
        } else {
          loginError.innerText = "Wrong password";
        }
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // ================= DRAWER =================
    function openDrawer() { drawer.classList.add("open"); overlay.classList.add("show"); }
    function closeDrawer() { drawer.classList.remove("open"); overlay.classList.remove("show"); }
    function extractId(url) {
      const m = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
      return m ? m[1] : null;
    }

    // ================= SHEET MANAGEMENT =================
    async function loadMasterSheets() {
      showOverlaySpinner(true);
      try {
        const res = await fetch(MASTER_API);
        sheets = await res.json();
        renderSheetList();
        loadSheetDropdown();
      } catch (err) {
        alert("Failed to load master sheet. Make sure it is public.");
        console.error(err);
      } finally {
        showOverlaySpinner(false);
      }
    }

    function renderSheetList() {
      const container = document.getElementById("sheetList");
      container.innerHTML = "";
      sheets.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "d-flex justify-content-between align-items-center mb-2";
        div.innerHTML = `
      <span>${s.name}</span>
      <div>
        <button class="btn btn-sm btn-primary me-1" onclick="editSheet(${i})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteSheet(${i}, this)">Delete</button>
      </div>
    `;
        container.appendChild(div);
      });
    }

    function editSheet(index) {
      const s = sheets[index];
      editingIndex = index;

      document.getElementById("addSection").classList.add("d-none");
      const editSection = document.getElementById("editSection");
      editSection.classList.remove("d-none");

      const editName = document.getElementById("editSheetName");
      const editUrl = document.getElementById("editSheetUrl");

      editName.value = s.name || "";
      editUrl.value = s.url ? (s.url.includes("/edit") ? s.url : `https://docs.google.com/spreadsheets/d/${s.id}/edit`) : "";
    }

    // Discard editing
    function discardEdit() {
      editingIndex = null;
      document.getElementById("editSection").classList.add("d-none");
      document.getElementById("addSection").classList.remove("d-none");
      document.getElementById("editSheetName").value = "";
      document.getElementById("editSheetUrl").value = "";
    }

    // Add new sheet
    async function addSheet(btn) {
      const name = document.getElementById("sheetName").value.trim();
      const url = document.getElementById("sheetUrl").value.trim();
      if (!name || !url) return alert("Invalid input");

      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Adding...' + createSpinner();
      showOverlaySpinner(true);

      try {
        await fetch(MASTER_API, {
          method: "POST",
          body: JSON.stringify({ action: "add", name, url })
        });
        document.getElementById("sheetName").value = "";
        document.getElementById("sheetUrl").value = "";
        await loadMasterSheets();
        const newIndex = sheets.length - 1;
        sheetSelect.value = newIndex;
        drawerSheetSelect.value = newIndex;
        await loadSelectedSheet();
        closeDrawer();
      } catch (err) {
        alert("Failed to add sheet: " + err.message);
        console.error(err);
      } finally {
        showOverlaySpinner(false);
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // Submit edit
    async function submitEdit(btn) {
      const name = document.getElementById("editSheetName").value.trim();
      const url = document.getElementById("editSheetUrl").value.trim();
      if (!name || !url) return alert("Invalid input");

      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Updating...' + createSpinner();
      showOverlaySpinner(true);

      try {
        await fetch(MASTER_API, {
          method: "POST",
          body: JSON.stringify({ action: "edit", index: editingIndex, name, url })
        });
        discardEdit();
        await loadMasterSheets();
      } catch (err) {
        alert("Failed to update sheet: " + err.message);
        console.error(err);
      } finally {
        showOverlaySpinner(false);
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    async function addOrUpdateSheet(btn) {
      btn = btn || event.target;
      const name = sheetName.value.trim();
      const url = sheetUrl.value.trim();
      if (!name || !url) return alert("Invalid input");

      const body = editingIndex !== null
        ? { action: "edit", index: editingIndex, name, url }
        : { action: "add", name, url };

      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = (editingIndex !== null ? 'Updating...' : 'Adding...') + createSpinner();

      showOverlaySpinner(true);
      try {
        await fetch(MASTER_API, {
          method: "POST",
          body: JSON.stringify(body)
        });

        sheetName.value = "";
        sheetUrl.value = "";
        editingIndex = null;
        await loadMasterSheets();
        closeDrawer();
      } catch (err) {
        alert("Failed to update sheet: " + err.message);
        console.error(err);
      } finally {
        showOverlaySpinner(false);
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    async function deleteSheet(index, btn) {
      if (!confirm("Are you sure you want to delete this sheet?")) return;
      btn.disabled = true;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'Deleting...' + createSpinner();

      showOverlaySpinner(true);
      try {
        await fetch(MASTER_API, {
          method: "POST",
          body: JSON.stringify({ action: "delete", index })
        });
        await loadMasterSheets();
      } catch (err) {
        alert("Failed to delete sheet: " + err.message);
        console.error(err);
      } finally {
        showOverlaySpinner(false);
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }


    function loadSheetDropdown() {
      const select = document.getElementById("sheetSelect");
      const drawerSelect = document.getElementById("drawerSheetSelect");

      select.innerHTML = "";
      drawerSelect.innerHTML = "";

      sheets.forEach((s, i) => {
        const opt1 = document.createElement("option");
        opt1.value = i;
        opt1.textContent = s.name;
        select.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = i;
        opt2.textContent = s.name;
        drawerSelect.appendChild(opt2);
      });

      // Show drawer dropdown only on mobile
      if (window.innerWidth <= 768) {
        document.getElementById("drawerDropdown").classList.remove("d-none");
      } else {
        document.getElementById("drawerDropdown").classList.add("d-none");
      }
    }

    function loadSelectedSheetFromDrawer() {
      const drawerSelect = document.getElementById("drawerSheetSelect");
      const index = drawerSelect.value;
      sheetSelect.value = index; // sync with navbar dropdown
      loadSelectedSheet();
    }


    // ================= LOAD TRANSACTIONS =================
    async function loadSelectedSheet() {
      const s = sheets[sheetSelect.value];
      if (!s) return;
      showOverlaySpinner(true);
      try {
        const res = await fetch(`https://docs.google.com/spreadsheets/d/${extractId(s.url)}/gviz/tq?tqx=out:json`);
        const t = await res.text();
        const json = JSON.parse(t.substring(47).slice(0, -2));
        parseMessages(json.table.rows);
      } catch (err) {
        alert("Failed to load transactions: " + err.message);
        console.error(err);
      } finally {
        showOverlaySpinner(false);
      }
    }

    // ================= PARSE & RENDER =================
    function parseMessages(rows) {
      transactions = [];
      let latestBalance = "--";

      rows.forEach(r => {
        const text = r.c[0]?.v;
        if (!text) return;

        const m = text.match(
          /Tk\s*([\d.]+).*from\s*(\d+).*Balance\s*Tk\s*([\d.]+).*TrxID\s*(\w+).*at\s*(\d{2}\/\d{2}\/\d{4})\s*(\d{2}:\d{2})/
        );
        if (!m) return;

        transactions.push({
          date: m[5],
          time: convertTime(m[6]),
          from: m[2],
          amount: m[1],
          trxid: m[4],
          balance: m[3]
        });

      });

      // Reverse the array so latest transactions are on top
      transactions.reverse();

      renderTable();
    }


    function convertTime(t) {
      let [h, m] = t.split(":");
      h = parseInt(h);
      const ap = h >= 12 ? "PM" : "AM";
      h = h % 12 || 12;
      return `${h}:${m} ${ap}`;
    }

    function renderTable() {
      const q = search.value.toLowerCase();
      let html = "";
      transactions
        .filter(t => Object.values(t).some(v => String(v).toLowerCase().includes(q)))
        .forEach(t => {
          html += `<tr>
        <td>${t.date}</td>
        <td>${t.time}</td>
        <td>${t.from}</td>
        <td>${t.amount}</td>
        <td>${t.trxid}</td>
        <td>${t.balance}</td>
      </tr>`;
        });
      tableBody.innerHTML = html;
    }

    async function refreshDashboard(btn) {
      btn = btn || event.target;

      const selectedIndex = sheetSelect.value;

      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = 'Refreshing...' + createSpinner();

      showOverlaySpinner(true);
      try {
        await loadMasterSheets();
        sheetSelect.value = selectedIndex;
        drawerSheetSelect.value = selectedIndex;
        await loadSelectedSheet(); // âœ… now loads correct sheet
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showOverlaySpinner(false);
      }
    }

  </script>


</body>

</html>



