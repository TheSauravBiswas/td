<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transaction Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background-color: #f4f6f8; }

/* Drawer */
.drawer {
  position: fixed;
  top: 0;
  left: -320px;
  width: 300px;
  height: 100%;
  background: #fff;
  box-shadow: 2px 0 10px rgba(0,0,0,0.15);
  padding: 15px;
  transition: 0.3s;
  z-index: 1050;
  overflow-y: auto;
}
.drawer.open { left: 0; }

/* Overlay */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  z-index: 1040;
}
.overlay.show { display: block; }

/* Global Loading Overlay */
#loadingOverlay {
  position: fixed;
  inset:0;
  background: rgba(0,0,0,0.5);
  display: none;
  z-index:2000;
  justify-content:center;
  align-items:center;
  flex-direction: column;
  color:white;
  font-size:20px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="d-flex vh-100 justify-content-center align-items-center">
  <div class="card p-4 shadow" style="width:300px">
    <h5 class="mb-3 text-center">üîê Login</h5>
    <input type="password" id="password" class="form-control mb-2" placeholder="Enter password">
    <button class="btn btn-primary w-100" id="loginBtn" onclick="handleLogin()">
      <span id="loginBtnText">Login</span>
      <span id="loginBtnSpinner" class="spinner-border spinner-border-sm d-none" role="status" style="margin-left:5px;"></span>
    </button>
    <div id="loginError" class="text-danger mt-2 text-center"></div>
  </div>
</div>

<!-- DRAWER -->
<div id="overlay" class="overlay" onclick="closeDrawer()"></div>
<div id="drawer" class="drawer">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5>Manage Sheets</h5>
    <button class="btn btn-sm btn-outline-secondary" onclick="closeDrawer()">‚úï</button>
  </div>

  <input id="sheetName" class="form-control mb-2" placeholder="Sheet Display Name">
  <input id="sheetUrl" class="form-control mb-2" placeholder="Google Sheet Share Link">
  <button class="btn btn-success w-100 mb-3" id="addBtn" onclick="addOrUpdateSheet()">
    <span id="addBtnText">Add / Update Sheet</span>
    <span id="addBtnSpinner" class="spinner-border spinner-border-sm d-none" role="status" style="margin-left:5px;"></span>
  </button>

  <div id="sheetList"></div>
</div>

<!-- APP -->
<div id="app" class="d-none">
<nav class="navbar navbar-dark bg-dark px-3">
  <button class="btn btn-outline-light me-2" onclick="openDrawer()">‚ò∞</button>

  <select id="sheetSelect" class="form-select w-auto" onchange="loadSelectedSheet()"></select>

  <div class="ms-auto bg-success text-white px-3 py-2 rounded">
    Balance: <strong id="balanceCard">--</strong>
  </div>
</nav>

<div class="container mt-4">
  <input id="search" class="form-control mb-3" placeholder="Search by anything..." oninput="renderTable()">

  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Date</th>
          <th>Time</th>
          <th>From</th>
          <th>Amount</th>
          <th>TrxID</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>
</div>

<!-- Global Loading Overlay -->
<div id="loadingOverlay" class="d-flex">
  <div class="spinner-border text-light mb-2" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  Loading...
</div>

<script>
const PASSWORD_HASH = "dc7897da62b97f518863cd7587dc5e9d9b0ce78441e2d6ba57e3d5582b90e370";
const MASTER_API = "YOUR_WEB_APP_URL_HERE"; // Replace with your Apps Script Web App URL

let transactions = [];
let sheets = [];
let editingIndex = null;

// ================= LOGIN =================
async function handleLogin() {
  const passwordInput = document.getElementById("password");
  const loginBox = document.getElementById("login");
  const app = document.getElementById("app");
  const loginError = document.getElementById("loginError");
  const loginBtnText = document.getElementById("loginBtnText");
  const loginBtnSpinner = document.getElementById("loginBtnSpinner");

  const input = passwordInput.value.trim();

  // Show button spinner only
  loginBtnText.innerText = "Logging in...";
  loginBtnSpinner.classList.remove("d-none");
  document.getElementById("loginBtn").disabled = true;

  try {
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(input));
    const hash = Array.from(new Uint8Array(buf))
                      .map(b => b.toString(16).padStart(2,"0"))
                      .join("");

    if(hash === PASSWORD_HASH){
      // Hide login, show dashboard
      loginBox.style.display = "none";
      app.style.display = "block";
      loginError.innerText = "";

      // Allow browser to render dashboard
      await new Promise(r => setTimeout(r, 50));

      // Show global loader while fetching dashboard
      showLoader();
      await loadMasterSheets();
      await loadSelectedSheet();
      hideLoader();
    } else {
      loginError.innerText = "Wrong password";
    }
  } catch(err){
    console.error(err);
    loginError.innerText = "Error logging in";
  } finally {
    loginBtnText.innerText = "Login";
    loginBtnSpinner.classList.add("d-none");
    document.getElementById("loginBtn").disabled = false;
  }
}

// ================= DRAWER =================
function openDrawer() { drawer.classList.add("open"); overlay.classList.add("show"); }
function closeDrawer() { drawer.classList.remove("open"); overlay.classList.remove("show"); }
function extractId(url) { const m = url.match(/\/d\/([a-zA-Z0-9-_]+)/); return m ? m[1] : null; }

// ================= LOADING =================
function showLoader() { document.getElementById("loadingOverlay").style.display="flex"; }
function hideLoader() { document.getElementById("loadingOverlay").style.display="none"; }

// ================= SHEET MANAGEMENT =================
async function loadMasterSheets() {
  showLoader();
  try {
    const res = await fetch(MASTER_API);
    sheets = await res.json();
    renderSheetList();
    loadSheetDropdown();
  } catch(err) {
    alert("Failed to load master sheet. Make sure it is public.");
    console.error(err);
  } finally { hideLoader(); }
}

function renderSheetList() {
  const container = document.getElementById("sheetList");
  container.innerHTML = "";
  sheets.forEach((s,i)=>{
    const div = document.createElement("div");
    div.className="d-flex justify-content-between align-items-center mb-2";
    div.innerHTML=`
      <span>${s.name}</span>
      <div>
        <button class="btn btn-sm btn-primary me-1" onclick="editSheet(${i})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteSheet(${i}, this)">Delete</button>
      </div>`;
    container.appendChild(div);
  });
}

function editSheet(index) {
  const s = sheets[index];
  sheetName.value = s.name;
  sheetUrl.value = s.url;
  editingIndex = index;
}

async function addOrUpdateSheet() {
  const name = sheetName.value.trim();
  const url = sheetUrl.value.trim();
  if(!name || !url) return alert("Invalid input");

  const btnText = document.getElementById("addBtnText");
  const btnSpinner = document.getElementById("addBtnSpinner");
  const addBtn = document.getElementById("addBtn");

  btnText.innerText = editingIndex!==null?"Updating...":"Adding...";
  btnSpinner.classList.remove("d-none");
  addBtn.disabled = true;

  showLoader();
  try {
    const body = editingIndex!==null
      ? { action:"edit", index:editingIndex, name, url }
      : { action:"add", name, url };

    await fetch(MASTER_API, { method:"POST", body:JSON.stringify(body) });
    sheetName.value=""; sheetUrl.value=""; editingIndex=null;

    await loadMasterSheets();
    await loadSelectedSheet();
  } catch(err){
    alert("Failed to update sheet.");
    console.error(err);
  } finally {
    hideLoader();
    closeDrawer();
    btnText.innerText = "Add / Update Sheet";
    btnSpinner.classList.add("d-none");
    addBtn.disabled = false;
  }
}

async function deleteSheet(index, btn) {
  if(!confirm("Are you sure you want to delete this sheet?")) return;

  const oldText = btn.innerText;
  btn.innerText = "Deleting...";
  btn.disabled = true;
  showLoader();

  try {
    await fetch(MASTER_API,{ method:"POST", body: JSON.stringify({ action:"delete", index }) });
    await loadMasterSheets();
    await loadSelectedSheet();
  } catch(err){
    alert("Failed to delete sheet.");
    console.error(err);
  } finally {
    hideLoader();
    btn.disabled = false;
    btn.innerText = oldText;
  }
}

// ================= DROPDOWN =================
function loadSheetDropdown() {
  const select=document.getElementById("sheetSelect");
  select.innerHTML="";
  sheets.forEach((s,i)=>{
    const opt=document.createElement("option");
    opt.value=i;
    opt.textContent=s.name;
    select.appendChild(opt);
  });
  if(sheets.length) loadSelectedSheet();
}

// ================= LOAD TRANSACTIONS =================
function loadSelectedSheet() {
  const s=sheets[sheetSelect.value];
  if(!s) return;
  showLoader();
  fetch(`https://docs.google.com/spreadsheets/d/${extractId(s.url)}/gviz/tq?tqx=out:json`)
    .then(r=>r.text())
    .then(t=>{
      const json = JSON.parse(t.substring(47).slice(0,-2));
      parseMessages(json.table.rows);
    }).finally(()=>hideLoader());
}

function parseMessages(rows) {
  transactions=[];
  let latestBalance="--";

  rows.forEach(r=>{
    const text=r.c[0]?.v;
    if(!text) return;
    const m=text.match(/Tk ([\d.]+).*from (\d+).*Balance Tk ([\d.]+).*TrxID (\w+).*at (\d{2}\/\d{2}\/\d{4}) (\d{2}:\d{2})/);
    if(!m) return;

    latestBalance=m[3];
    transactions.push({
      date:m[5],
      time:convertTime(m[6]),
      from:m[2],
      amount:m[1],
      trxid:m[4],
      balance:m[3]
    });
  });

  balanceCard.innerText="Tk "+latestBalance;
  renderTable();
}

function convertTime(t){
  let [h,m]=t.split(":");
  h=parseInt(h);
  const ap=h>=12?"PM":"AM";
  h=h%12||12;
  return `${h}:${m} ${ap}`;
}

function renderTable() {
  const q=search.value.toLowerCase();
  tableBody.innerHTML="";
  transactions.filter(t=>Object.values(t).some(v=>String(v).toLowerCase().includes(q)))
    .forEach(t=>{
      tableBody.innerHTML+=`
      <tr>
        <td>${t.date}</td>
        <td>${t.time}</td>
        <td>${t.from}</td>
        <td>${t.amount}</td>
        <td>${t.trxid}</td>
      </tr>`;
    });
}
</script>
</body>
</html>
